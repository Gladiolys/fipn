### Запуск
1. Установить Docker(https://docs.docker.com/get-started/) и Docker Compose(https://docs.docker.com/compose/install/)
2. Скопировать .env.example в .env
3. Заполнить .env
4. При 1 запуске, чтобы установить wordpress нужно временно убрать location = /wp-admin/install.php { deny all; } из nginx конфига, чтобы установщик был доступен, после установки wordpress вернуть обратно
5. Выполнить:
```
 docker-compose up
```
6. Выполнить
```
sudo chmod -R 777 wordpress/
```
7. Если не используйте wordpress папку из репы, то есть забавная штука. В docker контейнере изменены пути до папок в wordpress. 
Но при 1 старте папки создаются с именами по умолчанию. Приходится вручную переименовывать папки
   1. wp-content -> customization
   2. wp-content/plugins -> customization/wp-plugins 
   3. wp-content/uploads -> customization/multimedia (этой папки может не быть)

Также для разработки вам понадобиться установленный composer и NodeJs >=12

### Остановка
```
 docker-compose down
```

### Переустановка и удаление всего(сделай бэкап)
```
docker-compose down
docker rm $(docker ps -a -q)
docker rmi -f $(docker images -q)
sudo chmod -R 777 wordpress/
sudo chmod -R 777 _db/
sudo rm -rf _db
sudo rm -rf wordpress/
docker-compose up --force-recreate --remove-orphans
```

### Показать все запущенные контейнеры
```
docker ps -a
```

### Остановить все запущенные контейнеры
```
docker stop $(docker ps -a -q)
```

### Удалить все контейнеры
```
docker rm $(docker ps -a -q)
```

### Удалить все images
```
docker rmi $(docker images -q)
```

### Залезть внутрь контейнера
```
docker ps
docker exec -it <container name> /bin/bash
```
Для nginx /bin/sh

### Изменился .gitignore, как выкинуть уже закомиченные файлы
https://wp-kama.ru/note/gitignore-iskluchit-uzhe-dobavlenye-fajly

## Что вообще тут есть?
1. MySQL 8
2. PHP 7.4
3. PHPMyAdmin 5.1 - 10.227.22.3 (Содержит свой веб-сервер, костыльно настраивать чтобы поднимался из под nginx )
4. WordPress 5.9
5. NGINX 1.21 - 10.227.22.5 или 0.0.0.0
6. MailDev 10.227.22.6:1080 веб-морда, 10.227.22.6:1025 smtp сервер

## Структура каталогов

### Nginx
В папке nginx лежат кофиги nginx. Сейчас там лежит 2 конфига которые используется внутри docker-compose.

nginx.conf - это общий конфиг сервера, так лежат базовые настройки. NGINX устроен так, 
что этот файл технически невозможно объединить с конфигом конкретного веб-сервера.

fipn.conf - это конфиг веб-сервера настроенный под сайт.

### WordPress

wp-includes - файлы самого wordpress, не трогать никогда. Меняются только после обновления Wordpress.

wp-admin - файлы админки, не трогать без крайней необходимости, и только понимая что делаешь.

customization (wp-content) - код самого проекта. Тут вся нужная кодовая база.

```
- .env - переменные окружения
- docker-compose.yml - конфиг докера
- wordpress
    - customization:
        - multimedia (uploads) - папка с загружаемыми из админки файлами. внутри разбивка по году и номеру месяца загрузки
        
        - themes - папка с загруженными или написанными темами.
            - fipn - разрабатываемая тема
        
        - upgrade - создается WordPress автоматически при обновлении WordPress. 
        Эта папка используется для хранения новой версии WordPress, скачанной с WordPress.org. 
        Перед обновлением, WordPress скачивает архив и извлекает его содержимое в эту папку. 
        Чтобы процесс автоматического обновления протекал успешно, рекомендуется не трогать эту папку. 
        Если данная директория удалена, WordPress создаст её при следующем обновлении.
        
        - languages
            - themes
                  - fipn-ru_RU.po - исходники переводов темы fipn
                  - fipn-ru_RU.mo - билд переводов для темы fipn
                  
        - wp-plugins (plugins) - папка с установленнми или написанными плагинами
            -custom-setup - разрабатываемый плагин, 
            по сути туда сваливается код, который не особо относится к тебе
        - index.php - нужен чтобы веб-сервер не показывал структуру каталогов. Файл не трогать.
        Должен содержать <?php // Silence is golden. 
```

## Переменные окружения
1. MYSQL_ROOT_PASSWORD - пароль для root суперюзера. Нужно делать сложный, использоваться нигде не будет
2. MYSQL_USER - имя пользователя для основного пользователя, имеет рут права
3. MYSQL_PASSWORD - пароль для основного пользователя, имеет рут права
4. MYSQL_DATABASE - имя базы
5. WORDPRESS_TABLE_PREFIX - префикс для всех таблиц в бд. Используется для для повышения безопасности, так так у баз wordpress типовая структура
6. WORDPRESS_AUTH_KEY WORDPRESS_SECURE_AUTH_KEY WORDPRESS_LOGGED_IN_KEY WORDPRESS_NONCE_KEY WORDPRESS_AUTH_SALT 
WORDPRESS_SECURE_AUTH_SALT WORDPRESS_LOGGED_IN_SALT WORDPRESS_NONCE_SALT - ключи безопасности, генерятся автоматически или вручную тут https://api.wordpress.org/secret-key/1.1/salt/

WORDPRESS переменные соответствуют переменным wp-config.
Подробнее:
```
https://codex.wordpress.org/%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_wp-config.php
```
```
https://github.com/docker-library/wordpress/blob/master/wp-config-docker.php
```

### Безопасность
1. Изменено имя wp-content на customization 
2. Добавлен префикс к таблицам
3. Изменено имя uploads на multimedia 
4. Изменено имя plugins на wp-plugins 
5. Переопределен урл входа.
```
урл входа: /edit-content
```

6. Установлен плагин Security 
7. Настроены права на файлы
8. В nginx конфиге убран доступ к файлам плагинов и файлам конфигурации 
9. В админке отключен редактор файлов 
10. Настроены бэкапы бд 
11. Отключено php для загружаемых файлов, тем, плагинов 
12. Запрещен правами свободный доступ к важным файлам конфигурации wp-config и тд. 
13. Ограничено кол-во попыток входа 
14. Включены обязательные сложные пароли 
15. Скрыто получение версии wordpress в теме в functions.php
```
function wp_version_remove_version() {
  return '';
}
add_filter('the_generator', 'wp_version_remove_version');
```

## Как работают права
После 1 запуска и создания всех папок права устроены следующим образом:
В папке wordpress у корневой системы права на папки 755, а на файлы 644.
Файлы и папки принадлежат пользователю 82

В папке _db у корневой системы права на папки 750, 
а на файлы 640 600 и 644 в зависимости от файла. 
Файлы и папки принадлежат пользователю systemd-coredump

В docker контейнере:
В контейнере wordpress права такие-же как и в корневой системе, но принадлежат файлы пользователю www-data
В контейнере nginx права такие-же как и в корневой системе, но принадлежат файлы пользователю 82 с доступом для www-data

Если поменять права:
```
sudo chmod -R 777 wordpress/
```
то права в корневой системе синхронизируются с docker контейнерами, то есть внутри контейнеров тоже будет 777.

После установки всё настроено сразу как надо, но вот нам для нужд разработки нужны полные права на wordpress, 
чтобы писать код. Поэтому на develop машине нужно дать полные права на папку wordpress командой выше.
Плагины безопасности будут ругаться, но для dev режима это ок.

Как ограничить права
```
find . -type d -exec chmod 755 {} \;
find . -type f -exec chmod 644 {} \;
```

Проверить на проде:
1. файлы должны быть с правами 644 или 640
2. wp-config.php должен быть 440 или 400
3. каталоги должны обладать правами 755 или 750

### Посмотреть права в виде чисел
```
ls -l | awk '{k=0;for(i=0;i<=8;i++)k+=((substr($1,i+2,1)~/[rwx]/) \
             *2^(8-i));if(k)printf("%0o ",k);print}'
```

### Что хочу от SEO
robots.txt
sitemap
Предпросмотр как будет выглядеть пост в поисковиках и соц сетях
Настройку мета тегов(opengraph, twitter, базовые мета-теги)

## Плагины
1. Ленивая загрузка картинок, видео, iframes и тд. - a3 Lazy Load
2. Минификация и склеивание JS,CSS, HTML - Autoptimize
3. Кэш - WP Super Cache
4. Безопасность - iThemes Security
5. SEO - All in One SEO
6. Отключение комментов - Отключить комментарии
7. Статистика - WP Statistics
8. Встраивание PDF и Google docs - EmbedPress
9. Настройки SSL сертификата - Really Simple SSL
10. Миграция, бэкапы и восстановление - All-in-One WP Migration
11. Отключение неиспользуемого REST API - Отключить REST API
12. Спрятать страницу входа - WPS Hide Login
13. Настроить связь с SMTP сервером для отправки электронной почты - WP Mail SMTP
14. Интернационализация - Polylang
15. Версия для слабовидящих - Button visually impaired
16. Слайдер - Ultimate Responsive Image Slider - 3.5.6
17. Поддержка SVG - SVG Support

## Плагины которые могут пригодится в будущем
1. Advanced Custom Fields - кастомные поля и типы записей
2. User Role Editor - управление правами и ролями из админки
3. Kama Breadcrumbs - хлебные крошки
4. Query Monitor - отладка php и бд
5. Webcraftic Clearfy - замена плагина для оптимизации и защиты
6. Contact Form - топ для форм
7. Cookie Notice & Compliance for GDPR / CCPA - разрешение на сохранение куки
8. AddToAny Share Buttons - кнопки пошарить в соц сетях
9. TinyPNG - JPEG, PNG & WebP image compression - сжималка изображений

## Особенности
1. Для загрузки больших файлов используется кастомный uploads.ini
2. Иногда надо руками чистить журнал безопасности. Инструменты/ITSec Log Cleaner

## Как деплоить с Docker.
1. Самый простой путь:
Положить wordpress, _db папки и docker-compose.yaml, uploads.ini, .env на прод. 
Выполнить:
```
 docker-compose up
``` 

## Как деплоить без Docker.
1. Положить пуcтой wordpress на прод с настройками как в docker.
2. Используя плагин All-in-One WP Migration сделать дамп из develop машины
3. Импортировать дамп на прод через админку, раздел All-in-One WP Migration

Ещё можно попробовать после 1 шага просто положить папку customization на прод, 
а записи страницы и метрики перенести с помощью 
стандартной тулзы wordpress.(Инструменты/Импорт) или накаткой дампа базы сделанного с помощью PhpMyAdmin.
Но тут успех под вопросом.

### Урл базовых настроек темы 
`/wp-admin/customize.php`

### Структура БД
https://wp-kama.ru/note/wp-database-schema

### Иерархия шаблонов
1. 404.html - Страница открывается, если подходящая под урл страница не найдена.
2. archive.html - Страница открывается, если выполнен переход на страницу 
постов автора, постов определенной рубрики, постов по дате, постов по тэгу, архив таксономий.
3. blank.html - Минималистичный шаблон пустой страницы. 
Доступен для выбора при создании поста или страницы.
4. home.html - Главная страница.
5. page.html - Страница открывается, если выполнен переход на статичную страницу,
созданную в разделе `Страницы` с шаблоном по умолчанию.
6. single.html - Страница открывается, если выполнен переход на страницу 
конкретного поста, созданную в разделе `Записи` с шаблоном по умолчанию.
7. index.html - Страница открывается, если не найдено более конкретного шаблона 
для страницы, но сама страница по логике роутинга wordpress существует. 
Сейчас технически её нельзя открыть, так как шаблоны описанные выше 
покрывают все возможные страницы wordpress.

Чтобы создать кастомный шаблоны, нужно создать html файл включающий имя 
базового шаблона и добавить к нему имя кастомного шаблона. Также желательно описать
кастомный шаблон в `theme.json` После этого шаблон станет доступен для выбора 
в панели администратора при создании поста или страницы.

Подробнее про иерархию шаблонов: https://wp-kama.ru/id_7654/ierarhiya-fajlov-temy-shablona.html

## Пользователи
У пользователя может быть одна из 5 ролей:
1. Подписчик(subscriber) - просто авторизованный пользователь, не имеет никаких прав, 
нет смысла их создавать, так как комментарии отключены.
2. Участник(contributor) - может создавать посты. Но опубликовывать их не имеет права, 
только отправлять на рассмотрение пользователям с большими правами. 
Может просматривать список со всеми постами, но управлять может 
только своими не опубликованными. Если опубликовали, то редактировать уже нельзя. 
Может создать метку или выбрать рубрику.
3. Автор(author) - может создавать и публиковать посты, может полностью управлять 
библиотекой медиа файлов, может создавать метки и выбирать рубрики. 
Не может управлять чужими постами.
4. Редактор(editor) - имеет полные права на записи, метки, рубрики, медиафайлы и страницы. 
По сути самая нужная роль для контентмейкеров. Не имеет доступа к плагинам, 
инструментам, статистике и прочему такому.
5. Администратор(administrator) - доступна вся админка, нет никаких ограничений. Доступен 
значительно больший функционал чем редактору.

Есть ещё суперадминистратор, но он присутствует только когда wordpress работает в режиме нескольких сайтов 

Роль подписчика удалена кодом из темы(functions.php) из-за своей бесполезности.

С помощью кода или плагинов можно управлять ролями. 
Удалять старые, добавлять новые, менять права каждой роли. Всё настраиваемо, 
просто сейчас нет необходимости менять стандартные роли и права.

Подробнее: https://ru.wordpress.org/support/article/roles-and-capabilities/ https://wp-kama.ru/note/wp-capabilities-list

### Что сделано в коде плагина 
1. Отключена RSS лента, так как не нужен
2. Удалена роль subscriber, так как не нужна
### Что сделано в коде темы
1. Ограничены доступные в редакторе блоки

## Обновление
Настройки обновлений оставлены по умолчанию. То есть авто-обновление для плагинов и 
тем отключено. Переводы авто-обновляются. Настройки обновления ядра wordpress изменены.
Сайт авто-обновляется только при выходе выпусков технического обновления и обновлений безопасности WordPress.
При необходимости можно полностью отключить обновление добавив в плагин Custom Setup код ниже:
```php

// откл. обновл. ядра
add_filter( 'auto_update_core', '__return_false' );

// вкл. обновл. всех тем
add_filter( 'auto_update_theme', '__return_true' );

// вкл. обновл. всех  плагинов
add_filter( 'auto_update_plugin', '__return_true' );

// откл. обновл. всех  файлов перевода
add_filter( 'auto_update_translation', '__return_false' );

// отключаем письмо
add_filter( 'auto_core_update_send_email', '__return_false' );
```

## Интернационализация
Интернационализация самой темы производится стандартными средствами wordpress, через файл
`wordpress/customization/languages/themes/fipn-ru_RU.po`. 
Чтобы выполнять перевод можно редактировать файл вручную, 
но гораздо удобнее использовать Poedit программу. Преимущество в том, что в 
программе есть функция `Извлечь из исходного кода`. Которая автоматом создает 
все итемы переводов, остается только переводить. Эта фича не работает на `theme.json`.
Для него переводы надо добалять руками. Также после правок руками или в программе 
надо обязательно открыть в poedit и нажать сохранить, чтобы сгенерить `.mo` файл 
на основе исходного.

Скачать под любую ось можно тут: `https://poedit.net/`

Подробная информация о том как переводить темы и плагины: `https://wp-kama.ru/handbook/codex/translations`

Интернационализация постов и страниц производится с помощью плагина Polylang. 
У постов и страниц в списке есть флажок языка, на котором написан контент. 
Зайдя внутрь в правом меню можно будет добавить версию для другого языка.
Добавлено 2 языка, основной русский и английский. Перейти на английскую версию 
можно выбрав язык в шапке или дописав после домена сайта `/en`

## Открытые вопросы
Задеплоить на временный хост.
Поиск по сайту

## Сделать потом
1. Прогнать html на валидаторе
2. Прогнать css на валидаторе
3. Понять почему часть security заголовков не всегда добавляется


## Полезные ссылки
Исходный код блоков - https://github.com/WordPress/gutenberg/tree/trunk/packages/block-library/src

Дока по theme.json - https://github.com/WordPress/gutenberg/blob/5654e3dff70d1cd84d7f74aa6d211683a99ff366/docs/how-to-guides/themes/theme-json.md

Список блоков с описанием - https://github.com/WordPress/gutenberg/blob/5654e3dff70d1cd84d7f74aa6d211683a99ff366/docs/reference-guides/core-blocks.md
или https://fullsiteediting.com/block-reference/
Как сделать свой блок - https://github.com/WordPress/gutenberg/tree/5654e3dff70d1cd84d7f74aa6d211683a99ff366/docs/getting-started/create-block

Поиск - https://wp-kama.ru/function/get_search_form
